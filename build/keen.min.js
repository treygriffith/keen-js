"object"!=typeof JSON&&(JSON={}),function(){"use strict";function f(e){return 10>e?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,i,o,r,a,s=gap,l=t[e];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(e)),"function"==typeof rep&&(l=rep.call(t,e,l)),typeof l){case"string":return quote(l);case"number":return isFinite(l)?l+"":"null";case"boolean":case"null":return l+"";case"object":if(!l)return"null";if(gap+=indent,a=[],"[object Array]"===Object.prototype.toString.apply(l)){for(r=l.length,n=0;r>n;n+=1)a[n]=str(n,l)||"null";return o=0===a.length?"[]":gap?"[\n"+gap+a.join(",\n"+gap)+"\n"+s+"]":"["+a.join(",")+"]",gap=s,o}if(rep&&"object"==typeof rep)for(r=rep.length,n=0;r>n;n+=1)"string"==typeof rep[n]&&(i=rep[n],o=str(i,l),o&&a.push(quote(i)+(gap?": ":":")+o));else for(i in l)Object.prototype.hasOwnProperty.call(l,i)&&(o=str(i,l),o&&a.push(quote(i)+(gap?": ":":")+o));return o=0===a.length?"{}":gap?"{\n"+gap+a.join(",\n"+gap)+"\n"+s+"}":"{"+a.join(",")+"}",gap=s,o}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,n){var i;if(gap="",indent="","number"==typeof n)for(i=0;n>i;i+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var n,i,o=e[t];if(o&&"object"==typeof o)for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(i=walk(o,n),void 0!==i?o[n]=i:delete o[n]);return reviver.call(e,t,o)}var j;if(text+="",cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();var Keen=Keen||{};(function(){function e(){return"withCredentials"in new XMLHttpRequest}function t(e,t,n,i,o,r,a){var s=new XMLHttpRequest;if(s.onreadystatechange=function(){if(4==s.readyState)if(s.status>=200&&300>s.status){var e;try{e=JSON.parse(s.responseText)}catch(t){console.log("Could not JSON parse HTTP response: "+s.responseText),a&&a(s,t)}e&&r&&r(e)}else console.log("HTTP request failed."),a&&a(s,null)},s.open(e,t,!0),o&&s.setRequestHeader("Authorization",o),i&&s.setRequestHeader("Content-Type","application/json"),n)for(var l in n)n.hasOwnProperty(l)&&s.setRequestHeader(l,n[l]);var h=i?JSON.stringify(i):null;s.send(h)}function n(e,t,n,i){if(t&&0>e.indexOf("api_key")){var o=e.indexOf("?")>0?"&":"?";e=e+o+"api_key="+t}for(var r="keenJSONPCallback"+(new Date).getTime();r in window;)r+="a";var a=!1;window[r]=function(e){a=!0,n&&e&&n(e),window[r]=void 0},e=e+"&jsonp="+r;var s=document.createElement("script");s.id="keen-jsonp",s.src=e,document.getElementsByTagName("head")[0].appendChild(s),s.onreadystatechange=function(){a===!1&&"loaded"===this.readyState&&(a=!0,i&&i())},s.onerror=function(){a===!1&&(a=!0,i&&i())}}function i(e,t,n){var i="";return void 0!=n&&void 0!=n.attributes&&void 0!=n.attributes.timezone&&e.setMinutes(e.getMinutes()+e.getTimezoneOffset()+n.attributes.timezone/60),"daily"==t||"weekly"==t?(i+=1+e.getMonth(),i+="/",i+=e.getDate()):"hourly"==t?(i+=e.getHours(),i+=":",i+="00"):"monthly"==t?(i+=1+e.getMonth(),i+="/",i+=(e.getFullYear()+"").slice(-2)):"minutely"==t?(i+=e.getHours(),i+=":",i+=("0"+e.getMinutes()).slice(-2)):console.log("Invalid interval: "+t),i}function o(e){var t,n,i=[1,4,5,6,7,10,11],o=0;if(n=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(e)){for(var r,a=0;r=i[a];++a)n[r]=+n[r]||0;n[2]=(+n[2]||1)-1,n[3]=+n[3]||1,"Z"!==n[8]&&void 0!==n[9]&&(o=60*n[10]+n[11],"+"===n[9]&&(o=0-o)),t=Date.UTC(n[1],n[2],n[3],n[4],n[5]+o,n[6],n[7])}else t=Date.parse?Date.parse(e):0/0;return new Date(t)}function r(){return-60*(new Date).getTimezoneOffset()}function a(e){return _.each(e,function(t,n){_.isUndefined(t)&&delete e[n]}),_.map(e,function(e,t){return _.isString(e)||(e=JSON.stringify(e)),e=encodeURIComponent(e),t+"="+e}).join("&")}var s=!1;("undefined"==typeof console||console.log===void 0)&&(console={},console.log=s?function(e){alert(e)}:function(){});var l=function(){};if(l.extend=function(e,t){var n=l.prototype.extend;l._prototyping=!0;var i=new this;n.call(i,e),i.base=function(){},delete l._prototyping;var o=i.constructor,r=i.constructor=function(){if(!l._prototyping)if(this._constructing||this.constructor==r)this._constructing=!0,o.apply(this,arguments),delete this._constructing;else if(null!=arguments[0])return(arguments[0].extend||n).call(arguments[0],i)};return r.ancestor=this,r.extend=this.extend,r.forEach=this.forEach,r.implement=this.implement,r.prototype=i,r.toString=this.toString,r.valueOf=function(e){return"object"==e?r:o.valueOf()},n.call(r,t),"function"==typeof r.init&&r.init(),r},l.prototype={extend:function(e,t){if(arguments.length>1){var n=this[e];if(n&&"function"==typeof t&&(!n.valueOf||n.valueOf()!=t.valueOf())&&/\bbase\b/.test(t)){var i=t.valueOf();t=function(){var e=this.base||l.prototype.base;this.base=n;var t=i.apply(this,arguments);return this.base=e,t},t.valueOf=function(e){return"object"==e?t:i},t.toString=l.toString}this[e]=t}else if(e){var o=l.prototype.extend;l._prototyping||"function"==typeof this||(o=this.extend||o);for(var r={toSource:null},a=["constructor","toString","valueOf"],s=l._prototyping?0:1;h=a[s++];)e[h]!=r[h]&&o.call(this,h,e[h]);for(var h in e)r[h]||o.call(this,h,e[h])}return this}},l=l.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(e,t,n){for(var i in e)void 0===this.prototype[i]&&t.call(n,e[i],i,e)},implement:function(){for(var e=0;arguments.length>e;e++)"function"==typeof arguments[e]?arguments[e](this.prototype):this.prototype.extend(arguments[e]);return this},toString:function(){return this.valueOf()+""}}),Keen.configure=function(e,t,n){return this.client=new Keen.Client(e,t,n),this.client},Keen.addEvent=function(e,t,n,i){this.client&&this.client.uploadEvent(e,t,n,i)},Keen.getEventCollections=function(e,t){var n=this.client.getKeenUrl("/events");this.client.getJSON(n,e,t)},Keen.getEventCollectionProperties=function(e,t,n){var i=this.client.getKeenUrl("/events/"+e);this.client.getJSON(i,t,n)},Keen.setGlobalProperties=function(e){if(this.client){if(!e||"function"!=typeof e)throw Error("Invalid value for global properties: "+e);this.client.globalProperties=e}},Keen.addChartsReadyHandler=function(e){this.chartsReadyHandlers===void 0&&(this.chartsReadyHandlers=[]),this.chartsReadyHandlers.push(e),this.chartsReady&&this.runChartsReadyHandlers()},Keen.onChartsReady=function(e){this.chartsReady?e():(this.addChartsReadyHandler(e),this.loadChartsDependencies())},Keen.runChartsReadyHandlers=function(){_.each(this.chartsReadyHandlers,function(e){e()},this)},Keen.loadChartsDependencies=function(){if(!this.startedLoadingChartsDependencies){this.startedLoadingChartsDependencies=!0;var e=function(e,t){var n,i=document,o=i.head||i.getElementsByTagName("head");setTimeout(function(){if("item"in o){if(!o[0])return setTimeout(arguments.callee,25),void 0;o=o[0]}var n=i.createElement("script"),r=!1;n.onload=n.onreadystatechange=function(){return n.readyState&&"complete"!==n.readyState&&"loaded"!==n.readyState||r?!1:(n.onload=n.onreadystatechange=null,r=!0,t(),void 0)},n.src=e,o.insertBefore(n,o.firstChild)},0),null==i.readyState&&i.addEventListener&&(i.readyState="loading",i.addEventListener("DOMContentLoaded",n=function(){i.removeEventListener("DOMContentLoaded",n,!1),i.readyState="complete"},!1))},t=this,n=function(){t.chartsReady=!0,t.runChartsReadyHandlers()},i=function(){"undefined"==typeof google?console.log("Problem loading visualizations.  Please contact us!"):google.load("visualization","1.0",{packages:["corechart"],callback:n})};e("https://www.google.com/jsapi",function(){"undefined"==typeof _?e("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js",i):i()})}},Keen.Client=function(e,t,n){this.projectToken=e,this.apiKey=t,this.globalProperties=null,this.keenUrl="https://api.keen.io",void 0!==n&&void 0!==n.keenUrl&&(this.keenUrl=n.keenUrl)},Keen.Client.prototype.uploadEvent=function(i,o,r,a){var s=this.getKeenUrl("/events/"+i),l={};this.globalProperties&&(l=this.globalProperties(i));for(var h in o)o.hasOwnProperty(h)&&(l[h]=o[h]);if(e())t("POST",s,null,l,null,r,a);else{var u=JSON.stringify(l),c=Keen.Base64.encode(u);s=s+"?data="+c,s=s+"&modified="+(new Date).getTime(),n(s,null,r,a)}},Keen.Client.prototype.getKeenUrl=function(e){return this.keenUrl+"/3.0/projects/"+this.projectToken+e},Keen.Client.prototype.getJSON=function(i,o,r){e()?t("GET",i,null,null,this.apiKey,o,r):n(i,this.apiKey,o,r)},Keen.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,i,o,r,a,s,l="",h=0;for(e=Keen.Base64._utf8_encode(e);e.length>h;)t=e.charCodeAt(h++),n=e.charCodeAt(h++),i=e.charCodeAt(h++),o=t>>2,r=(3&t)<<4|n>>4,a=(15&n)<<2|i>>6,s=63&i,isNaN(n)?a=s=64:isNaN(i)&&(s=64),l=l+Keen.Base64._keyStr.charAt(o)+Keen.Base64._keyStr.charAt(r)+Keen.Base64._keyStr.charAt(a)+Keen.Base64._keyStr.charAt(s);return l},decode:function(e){var t,n,i,o,r,a,s,l="",h=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");e.length>h;)o=Keen.Base64._keyStr.indexOf(e.charAt(h++)),r=Keen.Base64._keyStr.indexOf(e.charAt(h++)),a=Keen.Base64._keyStr.indexOf(e.charAt(h++)),s=Keen.Base64._keyStr.indexOf(e.charAt(h++)),t=o<<2|r>>4,n=(15&r)<<4|a>>2,i=(3&a)<<6|s,l+=String.fromCharCode(t),64!=a&&(l+=String.fromCharCode(n)),64!=s&&(l+=String.fromCharCode(i));return l=Keen.Base64._utf8_decode(l)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;e.length>n;n++){var i=e.charCodeAt(n);128>i?t+=String.fromCharCode(i):i>127&&2048>i?(t+=String.fromCharCode(192|i>>6),t+=String.fromCharCode(128|63&i)):(t+=String.fromCharCode(224|i>>12),t+=String.fromCharCode(128|63&i>>6),t+=String.fromCharCode(128|63&i))}return t},_utf8_decode:function(e){for(var t="",n=0,i=c1=c2=0;e.length>n;)i=e.charCodeAt(n),128>i?(t+=String.fromCharCode(i),n++):i>191&&224>i?(c2=e.charCodeAt(n+1),t+=String.fromCharCode((31&i)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=String.fromCharCode((15&i)<<12|(63&c2)<<6|63&c3),n+=3);return t}},Keen._pId&&(Keen.configure(Keen._pId,Keen._ak,Keen._op),Keen._pId=null,Keen._ak=null,Keen._op=null),Keen._gp&&(Keen.setGlobalProperties(Keen._gp),Keen._gp=null),Keen._eq&&Keen._eq.length>0){for(var h=0;Keen._eq.length>h;h++){var u=Keen._eq[h].shift(),c=Keen._eq[h].shift(),d=Keen._eq[h].shift(),p=Keen._eq[h].shift();Keen.addEvent(u,c,d,p)}Keen._eq=null}if(Keen._ocrq&&Keen._ocrq.length>0){for(var h=0;Keen._ocrq.length>h;h++){var f=Keen._ocrq[h];Keen.onChartsReady(f)}Keen._ocrq=null}Keen.BaseVisualization=l.extend({}),Keen.BaseVisualization.prototype.getLabel=function(){if(_.isUndefined(this.options.label)||null==this.options.label){if(_.isUndefined(this.query.queryName)){var e="";return e+=this.query.attributes.analysisType,e+=" - ",e+=this.query.attributes.eventCollection}return this.query.queryName}return this.options.label},Keen.Number=Keen.BaseVisualization.extend({constructor:function(e,t){this.query=e,this.options={height:"150px",width:"300px","font-family":"'Helvetica Neue', Helvetica, Arial, sans-serif",color:"white","border-radius":"0px","number-background-color":"#7dcc77","label-background-color":"#9CD898",prefix:"",suffix:""},this.options=_.extend(this.options,t)}}),Keen.Number.prototype.draw=function(e,t){var n=function(e){return+e.replace(/[^\d.-]+/gi,"")},i=function(e){return e.replace(/[^A-Za-z%]+/gi,"")};e.innerHTML="";var o=document.createElement("div");e.appendChild(o),o.style.width=this.options.width,o.style.height=this.options.height,o.style.display="block",o.style.textAlign="center",o.style.backgroundColor=this.options["number-background-color"],o.style.borderRadius=this.options["border-radius"];var r=document.createElement("h1");o.appendChild(r);var a=document.createTextNode("Loading...");r.style.fontSize=.5*(8*n(this.options.height)/15)+i(this.options.height),r.appendChild(a),r.style.height=2*n(this.options.height)/3+i(this.options.height),r.style.lineHeight=r.style.height,r.style.color=this.options.color,r.style.fontWeight="bold",r.style.fontFamily=this.options["font-family"],r.style.margin=0,r.style.padding=0,r.style.textShadow="none";var s=document.createElement("h2");s.appendChild(document.createTextNode(this.getLabel())),o.appendChild(s),s.style.height=n(this.options.height)/3+i(this.options.height),s.style.lineHeight=s.style.height,s.style.fontSize=.32*(n(this.options.height)/3)+i(this.options.height),s.style.color=r.style.color,s.style.textTransform="uppercase",s.style.fontWeight="normal",s.style.fontFamily=r.style.fontFamily,s.style.margin=0,s.style.padding=0,s.style.borderTop="1px solid",s.style.borderTopColor=this.options.color,s.style.backgroundColor=this.options["label-background-color"],s.style.textShadow="none";var l=_.bind(function(e){this.data=e.result,null==this.data&&(this.data=0),r.replaceChild(document.createTextNode(this.options.prefix+Keen.prettyNumber(this.data)+this.options.suffix),a),r.style.fontSize=8*n(this.options.height)/15+i(this.options.height),null==this.data&&(this.data=0)},this);_.isUndefined(t)?this.query.getResponse(l):l(t)},Keen.LineChart=Keen.BaseVisualization.extend({constructor:function(e,t){this.query=e,this.options={chartAreaHeight:null,chartAreaWidth:null,chartAreaLeft:null,chartAreaTop:null,height:300,width:600,lineWidth:5,color:"#00afd7",backgroundColor:"white",title:null,label:null,xAxisLabel:null,yAxisLabel:null,showLegend:!0,xAxisLabelAngle:null},this.options=_.extend(this.options,t),this.client=_.isUndefined(this.options.client)?Keen.client:this.options.client}}),Keen.LineChart.prototype.draw=function(e,t){e.innerHTML="",e.style.width=this.options.width+"px",e.style.height=this.options.height+"px",e.style.display="block";var n=Keen.showLoading(e),r=function(e){var t={};return t.height=e.height,t.width=e.width,t.lineWidth=e.lineWidth,t.colors=[e.color],t.backgroundColor=e.backgroundColor,t.title=e.title,t.hAxis={title:e.xAxisLabel},t.vAxis={title:e.yAxisLabel,viewWindow:{min:0}},e.showLegend||(t.legend={position:"none"}),null!=e.xAxisLabelAngle&&(t.hAxis.slantedText=!0,t.hAxis.slantedTextAngle=e.xAxisLabelAngle),t.chartArea={left:e.chartAreaLeft,top:e.chartAreaTop,height:e.chartAreaHeight,width:e.chartAreaWidth},t},a=_.bind(function(t){this.data=t.result;var a=new google.visualization.DataTable;if(a.addColumn("string","Date"),a.addColumn("number",this.getLabel()),a.addRows(_.map(this.data,function(e){var t=o(e.timeframe.start),n=i(t,this.query.attributes.interval,this.query);return[n,e.value]},this)),google){var s=new google.visualization.AreaChart(e),l=r(this.options);clearInterval(n),s.draw(a,l)}else console.log("Charting is not yet ready.  Are you waiting for onChartsReady?")},this);_.isUndefined(t)?this.query.getResponse(a):a(t)},Keen.MultiLineChart=Keen.BaseVisualization.extend({constructor:function(e,t){this.query=e,this.options={height:300,width:600,chartAreaHeight:null,chartAreaWidth:null,chartAreaLeft:null,chartAreaTop:null,title:null,showLegend:!0,colors:null,lineWidth:5,backgroundColor:"white",fontColor:"black",xAxisLabel:null,yAxisLabel:null,xAxisLabelAngle:null},this.options=_.extend(this.options,t),this.client=_.isUndefined(this.options.client)?Keen.client:this.options.client}}),Keen.MultiLineChart.prototype.draw=function(e,t){e.innerHTML="",e.style.width=this.options.width+"px",e.style.height=this.options.height+"px",e.style.display="block";var n=Keen.showLoading(e),r=function(e){var t={};return t.height=e.height,t.width=e.width,t.lineWidth=e.lineWidth,t.colors=e.colors,t.backgroundColor=e.backgroundColor,t.title=e.title,t.label=e.label,t.hAxis={title:e.xAxisLabel},t.vAxis={title:e.yAxisLabel,viewWindow:{min:0}},e.showLegend||(t.legend={position:"none"}),null!=e.xAxisLabelAngle&&(t.hAxis.slantedText=!0,t.hAxis.slantedTextAngle=e.xAxisLabelAngle),t.chartArea={left:e.chartAreaLeft,top:e.chartAreaTop,height:e.chartAreaHeight,width:e.chartAreaWidth},t},a=_.bind(function(t){this.data=t.result;var a=[];_.each(this.data[0].value,function(e){a.push(e[this.query.attributes.groupBy])},this),0==a.length&&(a.push(null),this.options.showLegend=!1);var s=new google.visualization.DataTable;if(s.addColumn("string","Date"),_.each(a,function(e){s.addColumn("number",e)}),_.each(this.data,function(e){var t=[],n=o(e.timeframe.start),r=i(n,this.query.attributes.interval);t.push(r),_.each(e.value,function(e){null==e.result&&(e.result=0),t.push(e.result)},this),1==t.length&&t.push(null),s.addRow(t)},this),google){var l=new google.visualization.LineChart(e),h=r(this.options);clearInterval(n),l.draw(s,h)}else console.log("Charting is not yet ready.  Are you waiting for onChartsReady?")},this);_.isUndefined(t)?this.query.getResponse(a):a(t)},Keen.ColumnChart=Keen.BaseVisualization.extend({constructor:function(e,t){this.query=e,this.options={height:300,width:600,chartAreaHeight:null,chartAreaWidth:null,chartAreaLeft:null,chartAreaTop:null,barWidth:20,title:null,showLegend:!0,colors:null,backgroundColor:"white",fontColor:"black",xAxisLabel:null,yAxisLabel:null},this.options=_.extend(this.options,t),this.client=_.isUndefined(this.options.client)?Keen.client:this.options.client}}),Keen.ColumnChart.prototype.draw=function(e,t,n){e.innerHTML="",e.style.width=this.options.width+"px",e.style.height=this.options.height+"px",e.style.display="block";var i=Keen.showLoading(e),o=function(e){var t={};return t.legend={},t.height=e.height,t.width=e.width,t.title=e.title,t.colors=e.colors,t.fontColor=e.fontColor,t.backgroundColor=e.backgroundColor,t.hAxis={title:e.xAxisLabel,titleTextStyle:{color:e.xAxisLabelColor}},t.vAxis={title:e.yAxisLabel,viewWindow:{min:0},titleTextStyle:{color:e.yAxisLabelColor}},e.showLegend||(t.legend.position="none"),t.titleTextStyle={color:e.fontColor},t.legend.textStyle={color:e.fontColor},t.chartArea={left:e.chartAreaLeft,top:e.chartAreaTop,height:e.chartAreaHeight,width:e.chartAreaWidth},t},r=_.bind(function(t){this.data=t.result;var r=new google.visualization.DataTable;if(r.addColumn("string","Group By"),r.addColumn("number",this.getLabel()),_.each(this.data,function(e){var t=e[this.query.attributes.groupBy]+"",n=e.result;r.addRow([t,n])},this),google){var a=new google.visualization.ColumnChart(e);clearInterval(i),a.draw(r,o(this.options)),n&&n()}else console.log("Charting is not yet ready.  Are you waiting for onChartsReady?")},this);_.isUndefined(t)?this.query.getResponse(r):r(t)},Keen.BarChart=Keen.BaseVisualization.extend({constructor:function(e,t){this.query=e,this.options={height:300,width:600,chartAreaHeight:null,chartAreaWidth:null,chartAreaLeft:null,chartAreaTop:null,barWidth:20,title:null,showLegend:!0,colors:null,backgroundColor:"white",fontColor:"black",xAxisLabel:null,yAxisLabel:null},this.options=_.extend(this.options,t),this.client=_.isUndefined(this.options.client)?Keen.client:this.options.client}}),Keen.BarChart.prototype.draw=function(e,t,n){e.innerHTML="",e.style.width=this.options.width+"px",e.style.height=this.options.height+"px",e.style.display="block";var i=Keen.showLoading(e),o=function(e){var t={};return t.legend={},t.height=e.height,t.width=e.width,t.title=e.title,t.colors=e.colors,t.fontColor=e.fontColor,t.backgroundColor=e.backgroundColor,t.hAxis={title:e.xAxisLabel,titleTextStyle:{color:e.xAxisLabelColor}},t.vAxis={title:e.yAxisLabel,viewWindow:{min:0},titleTextStyle:{color:e.yAxisLabelColor}},e.showLegend||(t.legend.position="none"),t.titleTextStyle={color:e.fontColor},t.legend.textStyle={color:e.fontColor},t.chartArea={left:e.chartAreaLeft,top:e.chartAreaTop,height:e.chartAreaHeight,width:e.chartAreaWidth},t},r=_.bind(function(t){this.data=t.result;var r=new google.visualization.DataTable;if(r.addColumn("string","Group By"),r.addColumn("number",this.getLabel()),_.each(this.data,function(e){var t=e[this.query.attributes.groupBy]+"",n=e.result;r.addRow([t,n])},this),google){var a=new google.visualization.BarChart(e);clearInterval(i),a.draw(r,o(this.options)),n&&n()}else console.log("Charting is not yet ready.  Are you waiting for onChartsReady?")},this);_.isUndefined(t)?this.query.getResponse(r):r(t)},Keen.PieChart=Keen.BaseVisualization.extend({constructor:function(e,t){this.query=e,this.options={height:300,width:600,chartAreaHeight:null,chartAreaWidth:null,chartAreaLeft:null,chartAreaTop:null,minimumSlicePercentage:"1",title:null,showLegend:!0,colors:null,backgroundColor:"white",fontColor:"black"},this.options=_.extend(this.options,t),this.client=_.isUndefined(this.options.client)?Keen.client:this.options.client}}),Keen.PieChart.prototype.draw=function(e,t,n){e.innerHTML="",e.style.width=this.options.width+"px",e.style.height=this.options.height+"px",e.style.display="block";var i=Keen.showLoading(e),o=function(e){var t={};return t.legend={},t.height=e.height,t.width=e.width,t.title=e.title,t.sliceVisibilityThreshold=.01*e.minimumSlicePercentage,t.colors=e.colors,t.backgroundColor=e.backgroundColor,e.showLegend||(t.legend.position="none"),t.titleTextStyle={color:e.fontColor},t.legend.textStyle={color:e.fontColor},t.chartArea={left:e.chartAreaLeft,top:e.chartAreaTop,height:e.chartAreaHeight,width:e.chartAreaWidth},t},r=_.bind(function(t){this.data=t.result;var r=new google.visualization.DataTable;if(r.addColumn("string","Group By"),r.addColumn("number",this.getLabel()),_.each(this.data,function(e){var t=e[this.query.attributes.groupBy]+"",n=e.result;r.addRow([t,n])},this),google){var a=new google.visualization.PieChart(e);clearInterval(i),a.draw(r,o(this.options)),n&&n()}else console.log("Charting is not yet ready.  Are you waiting for onChartsReady?")},this);_.isUndefined(t)?this.query.getResponse(r):r(t)},Keen.FunnelChart=Keen.BaseVisualization.extend({constructor:function(e,t){this.query=e,this.options={height:300,width:600,chartAreaHeight:null,chartAreaWidth:null,chartAreaLeft:null,chartAreaTop:null,title:null,showLegend:!1,color:"#f35757",backgroundColor:"white",fontColor:"black"},this.options=_.extend(this.options,t),this.client=_.isUndefined(this.options.client)?Keen.client:this.options.client}}),Keen.FunnelChart.prototype.draw=function(e,t){e.innerHTML="",e.style.width=this.options.width+"px",e.style.height=this.options.height+"px",e.style.display="block";var n=Keen.showLoading(e),i=function(e){var t={};return t.legend={},t.height=e.height,t.width=e.width,t.title=e.title,t.colors=[e.color],t.backgroundColor=e.backgroundColor,e.showLegend||(t.legend.position="none"),t.titleTextStyle={color:e.fontColor},t.legend.textStyle={color:e.fontColor},t.chartArea={left:e.chartAreaLeft,top:e.chartAreaTop,height:e.chartAreaHeight,width:e.chartAreaWidth},t.vAxis={minValue:0,format:"#"},t.bar={groupWidth:"90%"},t},o=_.bind(function(t){this.numbers=t.result,this.steps=t.steps;var o=new google.visualization.DataTable;o.addColumn("string","Action"),o.addColumn("number","Count");for(var r=null,a=0;this.numbers.length>a;a++){null==r&&(r=this.numbers[a]);var s=Math.round(100*(this.numbers[a]/r)),l=this.steps[a].event_collection;_.isUndefined(this.query.steps[a].name)||(l=this.query.steps[a].name),o.addRow([l+" ("+s+"%)",this.numbers[a]])}if(google){var h=new google.visualization.ColumnChart(e);clearInterval(n),h.draw(o,i(this.options))}else console.log("Charting is not yet ready.  Are you waiting for onChartsReady?")},this);_.isUndefined(t)?this.query.getResponse(o):o(t)},Keen.BaseQuery=l.extend({getResponse:function(e){function t(t){return e(t)}function n(e,t){console.log("got an error:"),console.log(e),console.log(t)}if(_.isUndefined(this.client.apiKey))console.log("Error: Please add an apiKey to Keen.configure() to perform analysis.");else{var i=this.getPath(),o=this.buildParams();i+="?",i+=a(o);var r=this.client.getKeenUrl(i);this.client.getJSON(r,t,n)}},getPath:function(){console.log("getPath() must be overridden")},buildParams:function(){console.log("buildParams() must be overridden")}}),Keen.SavedQuery=Keen.BaseQuery.extend({constructor:function(e,t){this.queryName=e,this.client=t?t:Keen.client},getPath:function(){return"/saved_queries/"+encodeURIComponent(this.queryName)+"/result"},buildParams:function(){return{api_key:this.client.apiKey}}}),Keen.AdHocQuery=Keen.BaseQuery.extend({constructor:function(e,t,n){_.isUndefined(t)&&(t={}),this.attributes=_.defaults(t,{filters:[]}),this.attributes.eventCollection=e,_.isUndefined(this.attributes.timezone)&&(this.attributes.timezone=r()),this.client=n?n:Keen.client},getPath:function(){return"/queries/"+this.attributes.analysisType},buildParams:function(){return{api_key:this.client.apiKey,event_collection:this.attributes.eventCollection,filters:this.attributes.filters,timeframe:this.attributes.timeframe,timezone:this.attributes.timezone,target_property:this.attributes.targetProperty,group_by:this.attributes.groupBy}}}),Keen.AdHocQuery.prototype.addFilter=function(e,t,n){return this.attributes.filters.push({property_name:e,operator:t,property_value:n}),this},Keen.AdHocQuery.prototype.timeframe=function(e){return this.attributes.timeframe=e,this},Keen.AdHocQuery.prototype.timezone=function(e){return this.attributes.timezone=e,this},Keen.AdHocQuery.prototype.analysisType=function(e){return this.attributes.analysisType=e,this},Keen.AdHocQuery.prototype.targetProperty=function(e){return this.attributes.targetProperty=e,this},Keen.AdHocQuery.prototype.groupBy=function(e){return this.attributes.groupBy=e,this},Keen.Funnel=Keen.BaseQuery.extend({constructor:function(e,t,n){_.isUndefined(t)&&(t={}),this.attributes=t,_.isUndefined(e)&&(e=[]),this.steps=e;for(var i=0;this.steps.length>i;i++)this.steps[i]=this.steps[i].buildParams();_.isUndefined(this.attributes.timezone)&&(this.attributes.timezone=r()),this.client=n?n:Keen.client},getPath:function(){return"/queries/funnel"},buildParams:function(){if(!_.isUndefined(this.attributes.actorProperty))for(var e=0;this.steps.length>e;e++)_.isUndefined(this.steps[e].actor_property)&&(this.steps[e].actor_property=this.attributes.actorProperty);return{api_key:this.client.apiKey,steps:this.steps,timeframe:this.attributes.timeframe,timezone:this.attributes.timezone,actor_property:this.attributes.actorProperty}},draw:function(e,t){var n=new Keen.FunnelChart(this,t);n.draw(e)}}),Keen.Funnel.prototype.timeframe=function(e){return this.attributes.timeframe=e,this},Keen.Funnel.prototype.actorProperty=function(e){return this.attributes.actorProperty=e,this},Keen.Funnel.prototype.timezone=function(e){return this.attributes.timezone=e,this},Keen.Funnel.prototype.addStep=function(e){return this.steps.push(e.buildParams()),this},Keen.Step=Keen.AdHocQuery.extend({constructor:function(e,t){_.isUndefined(t)&&(t={}),this.attributes=_.defaults(t,{filters:[]}),this.attributes.eventCollection=e,_.isUndefined(this.attributes.timezone)&&(this.attributes.timezone=r())},buildParams:function(){return{event_collection:this.attributes.eventCollection,actor_property:this.attributes.actorProperty,filters:this.attributes.filters,timeframe:this.attributes.timeframe,timezone:this.attributes.timezone,name:this.attributes.name}}}),Keen.Step.prototype.name=function(e){return this.attributes.name=e,this},Keen.Step.prototype.actorProperty=function(e){return this.attributes.actorProperty=e,this},Keen.Metric=Keen.AdHocQuery.extend({}),Keen.Metric.prototype.drawBarChart=function(e,t,n){if(t.useVerticalBarChart===!0){var i=new Keen.ColumnChart(this,t);i.draw(e,void 0,n)}else{var o=new Keen.BarChart(this,t);o.draw(e,void 0,n)}},Keen.Metric.prototype.draw=function(e,t,n,i){if(_.isUndefined(this.attributes.groupBy)){var o=new Keen.Number(this,t);o.draw(e,void 0,i)}else{var r=new Keen.PieChart(this,t);r.draw(e,void 0,i)}},Keen.Series=Keen.AdHocQuery.extend({buildParams:function(){var e=this.base();return e.interval=this.attributes.interval,e},draw:function(e,t){if(_.isUndefined(this.attributes.groupBy)){var n=new Keen.LineChart(this,t);n.draw(e)}else{var i=new Keen.MultiLineChart(this,t);i.draw(e)}}}),Keen.Series.prototype.interval=function(e){return this.attributes.interval=e,this},Keen.showLoading=function(e){var t=function(e){return+e.replace(/[^\d.-]+/gi,"")},n=t(e.style.height);n=(n-96)/2;var i=document.createElement("div");i.style.cssText="margin: 0px auto;width: 96px;height: 96px;background: #f0f;position: relative;overflow: hidden;background: url(https://keen_web_static.s3.amazonaws.com/img/spinners/logo_spinner_sprite.png);background-position: 0px 0px;",i.style.top=n+"px",e.appendChild(i);var o=window.setInterval(function(){var e=i.style.backgroundPosition;e=e.split(" "),e=t(e[0]),e-=96,i.style.backgroundPosition=e+"px 0px"},64);return o},Keen.prettyNumber=function(e){function t(e,n){var e=e+"",i=e.split(".");if(i.length>1){e=i[0];var r=i[1];2==e.length&&r.length>0?r.length>0?e=e+"."+r.charAt(0):e+="0":1==e.length&&r.length>0&&(e=e+"."+r.charAt(0),e+=r.length>1?r.charAt(0):"0")}var a=e.length;return e.split(".").length>1&&a--,3>=a?e+""+o[n]:t(Number(e)/1e3,n+1)}var n=e.toPrecision(3);if(Number(n)==e&&4>=(e+"").length)return e+"";if(e>=1||-1>=e){var i="";0>e&&(e=-e,i="-");var o=["","k","M","B","T"];return i+t(e,0)}return e.toPrecision(3)},Date.prototype.stdTimezoneOffset=function(){var e=new Date(this.getFullYear(),-1,1),t=new Date(this.getFullYear(),6,1);return Math.max(e.getTimezoneOffset(),t.getTimezoneOffset())},Date.prototype.dst=function(){return this.getTimezoneOffset()<this.stdTimezoneOffset()},Keen.loadedCallback&&"function"==typeof Keen.loadedCallback&&Keen.loadedCallback()})();